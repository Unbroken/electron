From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Erik Olofsson <erik.olofsson@unbroken.se>
Date: Wed, 4 Feb 2026 13:40:51 +0100
Subject: [PATCH] feat: enable font render hinting control on Windows

Windows was explicitly excluded from font hinting configuration at
multiple levels in Chromium. This patch enables hinting control by:

1. Adding --font-render-hinting command line switch support on Windows
   (values: none, slight, medium, full) to override the default.

2. Removing the IS_WIN guard from RendererPreferencesToSkiaHinting()
   and adding SetHinting() call in the Windows code path so the
   hinting preference propagates to the renderer.

3. Adding font.setHinting() call in the Windows CreateSkFont() so
   the hinting level is actually applied to SkFont objects.

4. Enabling text-rendering: geometricPrecision CSS support on Windows
   by extending QuerySystemForRenderStyle() to handle the
   TextRenderingMode parameter and disable hinting when geometric
   precision is requested.
---
 .../renderer/core/exported/web_view_impl.cc    |  6 ++++--
 .../platform/fonts/font_platform_data.cc       |  2 +-
 .../platform/fonts/font_platform_data.h        |  5 ++---
 .../fonts/win/font_platform_data_win.cc        | 14 +++++++++++++-
 ui/gfx/font_render_params_win.cc               | 18 +++++++++++++++++-
 5 files changed, 37 insertions(+), 8 deletions(-)

diff --git a/third_party/blink/renderer/core/exported/web_view_impl.cc b/third_party/blink/renderer/core/exported/web_view_impl.cc
index eaf48d7c193d8..581aebcab6449 100644
--- a/third_party/blink/renderer/core/exported/web_view_impl.cc
+++ b/third_party/blink/renderer/core/exported/web_view_impl.cc
@@ -420,7 +420,7 @@ void RecordPrerenderActivationSignalDelay(const String& metric_suffix) {
       queueing_time);
 }
 
-#if !BUILDFLAG(IS_MAC) && !BUILDFLAG(IS_WIN)
+#if !BUILDFLAG(IS_MAC)
 SkFontHinting RendererPreferencesToSkiaHinting(
     const blink::RendererPreferences& prefs) {
 #if BUILDFLAG(IS_LINUX)
@@ -454,7 +454,7 @@ SkFontHinting RendererPreferencesToSkiaHinting(
       NOTREACHED();
   }
 }
-#endif  // !BUILDFLAG(IS_MAC) && !BUILDFLAG(IS_WIN)
+#endif  // !BUILDFLAG(IS_MAC)
 
 void ForEachFrameWidgetControlledByView(
     WebViewImpl& web_view,
@@ -3612,6 +3612,8 @@ void WebViewImpl::UpdateFontRenderingFromRendererPrefs() {
   WebFontRendering::SetLCDTextEnabled(
       renderer_preferences_.subpixel_rendering !=
       gfx::FontRenderParams::SUBPIXEL_RENDERING_NONE);
+  WebFontRenderStyle::SetHinting(
+      RendererPreferencesToSkiaHinting(renderer_preferences_));
 #else
   WebFontRenderStyle::SetHinting(
       RendererPreferencesToSkiaHinting(renderer_preferences_));
diff --git a/third_party/blink/renderer/platform/fonts/font_platform_data.cc b/third_party/blink/renderer/platform/fonts/font_platform_data.cc
index f9e8c1095e454..90f11a6772d23 100644
--- a/third_party/blink/renderer/platform/fonts/font_platform_data.cc
+++ b/third_party/blink/renderer/platform/fonts/font_platform_data.cc
@@ -121,7 +121,7 @@ FontPlatformData::FontPlatformData(sk_sp<SkTypeface> typeface,
             : 0;
   }
 #else
-  auto system_style = QuerySystemForRenderStyle();
+  auto system_style = QuerySystemForRenderStyle(text_rendering);
 #endif  // !BUILDFLAG(IS_WIN)
   style_.OverrideWith(system_style);
 #endif  // !BUILDFLAG(IS_MAC)
diff --git a/third_party/blink/renderer/platform/fonts/font_platform_data.h b/third_party/blink/renderer/platform/fonts/font_platform_data.h
index 07e92cc924311..5f1d67ca5ce10 100644
--- a/third_party/blink/renderer/platform/fonts/font_platform_data.h
+++ b/third_party/blink/renderer/platform/fonts/font_platform_data.h
@@ -149,9 +149,8 @@ class PLATFORM_EXPORT FontPlatformData
                                             TextRenderingMode text_rendering);
 #endif
 #if BUILDFLAG(IS_WIN)
-  // TODO(https://crbug.com/808221): Remove and use QuerySystemRenderStyle()
-  // instead.
-  WebFontRenderStyle QuerySystemForRenderStyle();
+  WebFontRenderStyle QuerySystemForRenderStyle(
+      TextRenderingMode text_rendering);
 #endif
 
   const sk_sp<SkTypeface> typeface_;
diff --git a/third_party/blink/renderer/platform/fonts/win/font_platform_data_win.cc b/third_party/blink/renderer/platform/fonts/win/font_platform_data_win.cc
index dd8f660c4fb3b..afbc42affeb22 100644
--- a/third_party/blink/renderer/platform/fonts/win/font_platform_data_win.cc
+++ b/third_party/blink/renderer/platform/fonts/win/font_platform_data_win.cc
@@ -34,6 +34,7 @@
 #include <windows.h>
 
 #include "third_party/blink/renderer/platform/fonts/font_cache.h"
+#include "third_party/blink/renderer/platform/fonts/font_description.h"
 #include "third_party/blink/renderer/platform/runtime_enabled_features.h"
 #include "third_party/blink/renderer/platform/web_test_support.h"
 #include "third_party/skia/include/core/SkFont.h"
@@ -46,6 +47,7 @@ SkFont FontPlatformData::CreateSkFont(const FontDescription*) const {
   font.setSize(SkFloatToScalar(text_size_));
   font.setEmbolden(synthetic_bold_);
   font.setSkewX(synthetic_italic_ ? -SK_Scalar1 / 4 : 0);
+  font.setHinting(static_cast<SkFontHinting>(style_.hint_style));
 
   bool use_subpixel_rendering = style_.use_subpixel_rendering;
   bool use_anti_alias = style_.use_anti_alias;
@@ -77,7 +79,8 @@ SkFont FontPlatformData::CreateSkFont(const FontDescription*) const {
   return font;
 }
 
-WebFontRenderStyle FontPlatformData::QuerySystemForRenderStyle() {
+WebFontRenderStyle FontPlatformData::QuerySystemForRenderStyle(
+    TextRenderingMode text_rendering) {
   WebFontRenderStyle style;
   style.use_anti_alias = 0;
   style.use_subpixel_rendering = 0;
@@ -97,6 +100,15 @@ WebFontRenderStyle FontPlatformData::QuerySystemForRenderStyle() {
     }
   }
 
+  // Handle text-rendering: geometricPrecision by disabling hinting.
+  if (text_rendering == TextRenderingMode::kGeometricPrecision &&
+      style.use_anti_alias) {
+    style.use_subpixel_positioning = true;
+    style.use_hinting = false;
+    // 0 means HINTING_NONE, see |ConvertHinting| in font_service_app.cc.
+    style.hint_style = 0;
+  }
+
   return style;
 }
 
diff --git a/ui/gfx/font_render_params_win.cc b/ui/gfx/font_render_params_win.cc
index 7151faefd2c98..22484ce32bbb4 100644
--- a/ui/gfx/font_render_params_win.cc
+++ b/ui/gfx/font_render_params_win.cc
@@ -10,6 +10,7 @@
 #include <optional>
 
 #include "base/callback_list.h"
+#include "base/command_line.h"
 #include "base/feature_list.h"
 #include "base/features.h"
 #include "base/files/file_path.h"
@@ -79,9 +80,24 @@ class CachedFontRenderParams {
     params_->subpixel_positioning = false;
     params_->autohinter = false;
     params_->use_bitmaps = false;
     params_->hinting = FontRenderParams::HINTING_MEDIUM;
     params_->subpixel_rendering = FontRenderParams::SUBPIXEL_RENDERING_NONE;
 
+    // Allow overriding font hinting via --font-render-hinting command line flag.
+    auto* command_line = base::CommandLine::ForCurrentProcess();
+    if (command_line->HasSwitch("font-render-hinting")) {
+      std::string hinting_str =
+          command_line->GetSwitchValueASCII("font-render-hinting");
+      if (hinting_str == "none")
+        params_->hinting = FontRenderParams::HINTING_NONE;
+      else if (hinting_str == "slight")
+        params_->hinting = FontRenderParams::HINTING_SLIGHT;
+      else if (hinting_str == "medium")
+        params_->hinting = FontRenderParams::HINTING_MEDIUM;
+      else if (hinting_str == "full")
+        params_->hinting = FontRenderParams::HINTING_FULL;
+    }
+
     BOOL enabled = false;
     if (SystemParametersInfo(SPI_GETFONTSMOOTHING, 0, &enabled, 0) && enabled) {
       params_->antialiasing = true;
-- 
2.52.0.windows.1

